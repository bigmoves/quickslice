# OG Image Generation Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Generate Open Graph images at build time for each documentation page, displaying page title with quickslice branding.

**Architecture:** Add `og_image` dependency to render Lustre elements as PNG files. Create a new `og.gleam` module that builds styled elements for each page, reusing the existing logo from `layout.gleam`. Integrate into the existing SSG build loop to generate images alongside HTML. Add meta tags to layout for social sharing.

**Tech Stack:** Gleam, Lustre, og_image, lustre_ssg

---

### Task 1: Add og_image Dependency

**Files:**
- Modify: `www/gleam.toml`

**Step 1: Add the dependency**

Add `og_image` as a path dependency in `www/gleam.toml`:

```toml
[dependencies]
gleam_stdlib = ">= 0.44.0 and < 2.0.0"
lustre_ssg = ">= 0.11.0 and < 1.0.0"
mork = ">= 1.8.0 and < 2.0.0"
simplifile = ">= 2.3.1 and < 3.0.0"
lustre = ">= 5.4.0 and < 6.0.0"
gleam_regexp = ">= 1.1.1 and < 2.0.0"
og_image = { path = "../../og_image" }
```

**Step 2: Verify dependency resolves**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam deps download`
Expected: Dependencies download successfully

**Step 3: Commit**

```bash
git add www/gleam.toml www/manifest.toml
git commit -m "feat(www): add og_image dependency"
```

---

### Task 2: Make Logo Function Public

**Files:**
- Modify: `www/src/www/layout.gleam`

**Step 1: Change logo function from private to public**

In `www/src/www/layout.gleam`, find:

```gleam
/// Render the quickslice logo SVG
fn logo() -> Element(Nil) {
```

Replace with:

```gleam
/// Render the quickslice logo SVG
pub fn logo() -> Element(Nil) {
```

**Step 2: Verify it compiles**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam build`
Expected: Build succeeds

**Step 3: Commit**

```bash
git add www/src/www/layout.gleam
git commit -m "refactor(www): make logo function public for reuse"
```

---

### Task 3: Create OG Image Rendering Module

**Files:**
- Create: `www/src/www/og.gleam`

**Step 1: Create the og.gleam module with render function**

Create `www/src/www/og.gleam`:

```gleam
/// OG image generation for doc pages
import lustre/attribute.{style}
import lustre/element.{type Element}
import lustre/element/html.{div, text}
import og_image
import www/config.{type DocPage}
import www/layout

/// Base URL for OG image links
pub const base_url = "https://quickslice.slices.network"

/// Render an OG image for a doc page
pub fn render(page: DocPage) -> Result(BitArray, og_image.RenderError) {
  page
  |> build_element
  |> og_image.render(og_image.defaults())
}

/// Build the Lustre element for the OG image
fn build_element(page: DocPage) -> Element(Nil) {
  div(
    [
      style([
        #("display", "flex"),
        #("flex-direction", "column"),
        #("justify-content", "center"),
        #("align-items", "flex-start"),
        #("width", "100%"),
        #("height", "100%"),
        #("padding", "80px"),
        #("background-color", "#0f0f17"),
        #("font-family", "Geist Sans"),
      ]),
    ],
    [
      layout.logo(),
      divider(),
      title(page.title),
      domain(),
    ],
  )
}

/// Gradient divider line
fn divider() -> Element(Nil) {
  div(
    [
      style([
        #("width", "300px"),
        #("height", "4px"),
        #("margin-top", "32px"),
        #("margin-bottom", "32px"),
        #("background", "linear-gradient(90deg, #FF6347, #00CED1, #32CD32)"),
        #("border-radius", "2px"),
      ]),
    ],
    [],
  )
}

/// Page title
fn title(page_title: String) -> Element(Nil) {
  div(
    [
      style([
        #("color", "#ffffff"),
        #("font-size", "72px"),
        #("font-weight", "700"),
        #("line-height", "1.1"),
      ]),
    ],
    [text(page_title)],
  )
}

/// Domain text at bottom
fn domain() -> Element(Nil) {
  div(
    [
      style([
        #("color", "#888888"),
        #("font-size", "24px"),
        #("margin-top", "auto"),
      ]),
    ],
    [text("quickslice.slices.network")],
  )
}

/// Get the output path for a page's OG image
pub fn output_path(page: DocPage) -> String {
  "priv/og/" <> page.slug <> ".png"
}

/// Get the URL for a page's OG image
pub fn url(page: DocPage) -> String {
  base_url <> "/og/" <> page.slug <> ".png"
}
```

**Step 2: Verify it compiles**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam build`
Expected: Build succeeds

**Step 3: Commit**

```bash
git add www/src/www/og.gleam
git commit -m "feat(www): add og image rendering module"
```

---

### Task 4: Integrate OG Generation into Build

**Files:**
- Modify: `www/src/www.gleam`

**Step 1: Update www.gleam to generate OG images**

Replace entire contents of `www/src/www.gleam` with:

```gleam
/// Docs site static site generator
import gleam/io
import gleam/list
import lustre/ssg
import simplifile
import www/config.{type DocPage}
import www/loader
import www/og
import www/page

pub fn main() -> Nil {
  case loader.load_all() {
    Error(err) -> {
      io.println("Error loading docs: " <> err)
    }
    Ok([]) -> {
      io.println("No pages to build")
    }
    Ok([first, ..rest]) -> {
      let all_pages = [first, ..rest]

      // Create og directory
      let _ = simplifile.create_directory_all("./priv/og")

      // Generate OG images for all pages
      list.each(all_pages, generate_og_image)

      // Add first route to get HasStaticRoutes type, then add remaining
      let cfg =
        ssg.new(config.out_dir)
        |> ssg.add_static_dir(config.static_dir)
        |> ssg.add_static_route(first.path, page.render(first, all_pages))
        |> add_routes(rest, all_pages)
        |> ssg.use_index_routes

      case ssg.build(cfg) {
        Ok(_) -> io.println("Build succeeded! Output: " <> config.out_dir)
        Error(_) -> io.println("Build failed!")
      }
    }
  }
}

fn generate_og_image(page: DocPage) -> Nil {
  case og.render(page) {
    Ok(bytes) -> {
      let path = og.output_path(page)
      case simplifile.write_bits(path, bytes) {
        Ok(_) -> io.println("Generated: " <> path)
        Error(_) -> io.println("Failed to write: " <> path)
      }
    }
    Error(_) -> io.println("Failed to render OG image for: " <> page.slug)
  }
}

fn add_routes(cfg, remaining: List(DocPage), all_pages: List(DocPage)) {
  case remaining {
    [] -> cfg
    [p, ..rest] -> {
      cfg
      |> ssg.add_static_route(p.path, page.render(p, all_pages))
      |> add_routes(rest, all_pages)
    }
  }
}
```

**Step 2: Verify it compiles**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam build`
Expected: Build succeeds

**Step 3: Test the build generates images**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam run`
Expected: Output shows "Generated: priv/og/..." for each page

**Step 4: Verify images exist**

Run: `ls -la /Users/chadmiller/code/quickslice/www/priv/og/`
Expected: PNG files for each doc page (index.png, queries.png, etc.)

**Step 5: Commit**

```bash
git add www/src/www.gleam
git commit -m "feat(www): generate og images during build"
```

---

### Task 5: Add OG Meta Tags to Layout

**Files:**
- Modify: `www/src/www/layout.gleam`

**Step 1: Add og import**

Add import at top of `www/src/www/layout.gleam`:

```gleam
import www/og
```

**Step 2: Add meta tags to head**

In the `wrap` function, find the `head` element:

```gleam
head([], [
  meta([attribute("charset", "UTF-8")]),
  meta([
    attribute("name", "viewport"),
    attribute("content", "width=device-width, initial-scale=1.0"),
  ]),
  title([], "quickslice - " <> page.title),
  link([rel("stylesheet"), href("/styles.css")]),
]),
```

Replace with:

```gleam
head([], [
  meta([attribute("charset", "UTF-8")]),
  meta([
    attribute("name", "viewport"),
    attribute("content", "width=device-width, initial-scale=1.0"),
  ]),
  title([], "quickslice - " <> page.title),
  meta([
    attribute("property", "og:title"),
    attribute("content", "quickslice - " <> page.title),
  ]),
  meta([
    attribute("property", "og:image"),
    attribute("content", og.url(page)),
  ]),
  meta([
    attribute("property", "og:type"),
    attribute("content", "website"),
  ]),
  meta([
    attribute("name", "twitter:card"),
    attribute("content", "summary_large_image"),
  ]),
  link([rel("stylesheet"), href("/styles.css")]),
]),
```

**Step 3: Verify it compiles**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam build`
Expected: Build succeeds

**Step 4: Test meta tags appear in output**

Run: `cd /Users/chadmiller/code/quickslice/www && gleam run && grep -o 'og:image.*png' priv/index.html`
Expected: Shows `og:image" content="https://quickslice.slices.network/og/index.png`

**Step 5: Commit**

```bash
git add www/src/www/layout.gleam
git commit -m "feat(www): add og meta tags to layout"
```

---

### Task 6: Final Verification

**Step 1: Clean build and test**

Run: `cd /Users/chadmiller/code/quickslice/www && rm -rf priv/og && gleam run`
Expected: All OG images regenerated, HTML files contain meta tags

**Step 2: Visually verify an image**

Run: `open /Users/chadmiller/code/quickslice/www/priv/og/queries.png`
Expected: Image shows quickslice logo, "Queries" title, gradient divider, domain text on dark background

**Step 3: Verify HTML meta tags**

Run: `grep -A1 'og:image' /Users/chadmiller/code/quickslice/www/priv/queries/index.html`
Expected: Shows correct og:image meta tag with full URL
